<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>HTML5学堂 - H5course</title>
	<link rel="stylesheet" href="../css/reset.css">
	<style>
		.wrap {
			width: 500px;
			margin: 50px auto;
			border: 1px solid #39f; 
		}
		.con div {
			width: 350px;
			margin: 40px auto 0;
		}
		.con input {
			overflow: hidden;
			width: 157px;
		}
		.button input {
			display: block;
			width: 200px;
			height: 50px;
			margin: 30px auto 0;
			line-height: 50px;
		}
		.con em {
			float: left;
		}
		.con p {
			margin-top: 5px;
		}
		.con span {
			float: left;
			margin-left: 10px;
		}
		.con strong {
			float: left;
			height: 20px;
			background: #39f;
		}
	</style>
</head>
<body>
	<div class="wrap">
		<div class="con clearfix" id="con">
			
		</div>
		<div class="button">
			<input id ="btn" type="button" value="提交投票结果">
		</div>
	</div>
	<script type="text/javascript">
		var con = document.getElementById('con');

		var Arr = ['A', 'B', 'C', 'D', 'E', 'F'];
		for (var i = 0; i < Arr.length; i++) {
				con.innerHTML += '\n<div>选项' + Arr[i] + '投票人数：<input type="text" value="">\n<p><em>投票占比：</em><strong></strong><span></span></p></div>';
			};	
			
		var	test = document.getElementById('con').getElementsByTagName('input'),
			bar = con.getElementsByTagName('strong');
			prop = document.getElementById('con').getElementsByTagName('span'),
			btn = document.getElementById('btn');

		//判断是否为数字类型，否则报错
		for (var i = 0; i < test.length; i++) {
			test[i].onblur = function() {
				var val = Number(this.value);
				if (val != val) {
					this.style.borderColor = '#f00';
					// 报错，点击按钮失效
					btn.disabled = "false";
					return;	
				} 
			}	
		};

		// 计算当前百分比
		btn.onclick = function() {
			var total = 0;
			var barwidth = 0;  // 存储柱状图宽度
			for (var i = 0; i < test.length; i++) {
				total += parseInt(test[i].value);
				console.log(total);
			};
			for (var i = 0; i < prop.length; i++) {
 				prop[i].innerText = (Math.round((parseInt(test[i].value) / total) * 10000) / 100).toFixed(2) + '%';
 				// 获取当前柱状图百分比宽度
 				barwidth = (Math.round((parseInt(test[i].value) / total) * 10000) / 100).toFixed(2);
 				//如果最小值小于1，则默认barWidth值为1，否则柱状图消失。
 				if (barwidth <= 1) {
 					barwidth = 1;
 				};
 				move(bar[i], {"width" :barwidth}, 20)
			};
		}	

		// 动画框架调用
		function move(ele, json, changeStep, fn) {
            var timerJudge = true; //默认所有的属性值到达终点；
            if (ele.timer) {
                clearInterval(ele.timer);
            };
            ele.timer =setInterval(function(){
                for(var newProp in json){
                    var startVal = parseInt(getStyle(ele,newProp));
                    var step = (json[newProp]-startVal)/changeStep;
                    step = (step>0) ? (Math.ceil(step)) : (Math.floor(step));
                    startVal += step;
                    if (Math.abs(startVal - json[newProp]) < 5) {
                        startVal = json[newProp]
                    };
                    if (startVal != json[newProp]) {
                        timerJudge = false;
                    };
                    ele.style[newProp] = startVal + "px"; 
                }
                if (timerJudge) {
                    clearInterval(ele.timer);
                    if (fn) {
                        fn();
                    };
                };
            }, 20);
        }
        function getStyle(ele,prop) {
            if (!document.defaultView) {
                eleStyle = element.currentStyle[prop];
            }else {
                eleStyle = document.defaultView.getComputedStyle(ele, null)[prop];
            }
            return eleStyle;
        } 		
	</script>
</body>
<html>
